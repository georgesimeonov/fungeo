<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Quiz - Flag Mode</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 5px;
            z-index: 1000;
        }

        #home-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 5px;
            z-index: 1000;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        #home-button:hover {
            background: #f0f0f0;
        }

        #flag-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #flag-img {
            max-width: 120px;
            max-height: 80px;
            border: 1px solid #ddd;
        }

        #flag-prompt {
            margin-top: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        #next-flag {
            margin-top: 10px;
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        #next-flag:hover {
            background: #2980b9;
        }

        #result-message {
            margin-top: 5px;
            font-size: 14px;
            font-weight: bold;
            min-height: 18px;
        }

        .correct {
            color: green;
        }

        .incorrect {
            color: red;
        }
    </style>
</head>

<body>
    <div id="score">Score: <span id="score-value">0</span></div>
    <a href="index.html" id="home-button">‚Üê Back to Menu</a>
    <div id="flag-container">
        <img id="flag-img" src="" alt="Country Flag">
        <div id="flag-prompt">Click on the country this flag belongs to</div>
        <div id="result-message"></div>
        <button id="next-flag">Next Flag</button>
    </div>
    <div id="map"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- Country Codes -->
    <script src="country-codes.js"></script>

    <script>
        let score = 0;
        let currentCountry = null;
        let countryLayers = {};
        let availableCountries = [];
        let alreadyGuessed = [];
        let geoJsonLayer = null;

        function updateScore(points) {
            score += points;
            document.getElementById('score-value').textContent = score;
        }

        // Function to get the correct flag URL using ISO codes
        function getCountryFlagURL(countryName) {
            // Try to find the ISO code for the country
            const isoCode = countryToISOCode[countryName];

            if (isoCode) {
                return `https://flagcdn.com/w160/${isoCode}.png`;
            } else {
                console.warn(`Warning: No ISO code found for ${countryName}`);
                return '';
            }
        }

        // Shuffle array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Reset the map to its original state
        function resetMap() {
            if (geoJsonLayer) {
                geoJsonLayer.setStyle({
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0
                });
            }
        }

        // Choose the next country to guess
        function selectNextCountry() {
            const resultMessage = document.getElementById('result-message');
            resultMessage.textContent = '';
            resultMessage.className = '';

            // Hide the next button
            document.getElementById('next-flag').style.display = 'none';

            // Reset the map completely instead of just the current country
            resetMap();

            // Filter out countries that have already been guessed
            const remainingCountries = availableCountries.filter(country => !alreadyGuessed.includes(country));

            // If all countries have been guessed, start over
            if (remainingCountries.length === 0) {
                alreadyGuessed = [];
                currentCountry = availableCountries[Math.floor(Math.random() * availableCountries.length)];
            } else {
                currentCountry = remainingCountries[Math.floor(Math.random() * remainingCountries.length)];
            }

            // Set the flag image
            const flagUrl = getCountryFlagURL(currentCountry);
            document.getElementById('flag-img').src = flagUrl;
        }

        // Handle click on the next flag button
        document.getElementById('next-flag').addEventListener('click', selectNextCountry);

        const map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            zoomControl: true,
            dragging: true,
            boxZoom: true,
            doubleClickZoom: true,
            scrollWheelZoom: true,
            touchZoom: true
        });

        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
            .then(response => response.json())
            .then(data => {
                geoJsonLayer = L.geoJSON(data, {
                    style: {
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            const countryName = feature.properties.name;

                            // Store the country layer for later reference
                            countryLayers[countryName] = layer;

                            // Add to available countries if it has a valid ISO code
                            if (countryToISOCode[countryName]) {
                                availableCountries.push(countryName);
                            }

                            layer.on('click', function () {
                                // If no current country is selected, do nothing
                                if (!currentCountry) return;

                                // Check if the clicked country matches the flag
                                const isCorrect = countryName === currentCountry;

                                // Update the score
                                updateScore(isCorrect ? 1 : -1);

                                // Color the country
                                layer.setStyle({
                                    fillColor: isCorrect ? 'green' : 'red',
                                    fillOpacity: 0.5
                                });

                                // Show result message
                                const resultMessage = document.getElementById('result-message');
                                if (isCorrect) {
                                    resultMessage.textContent = 'Correct!';
                                    resultMessage.className = 'correct';

                                    // Add to already guessed countries
                                    alreadyGuessed.push(currentCountry);
                                } else {
                                    resultMessage.textContent = `Incorrect! That was ${countryName}, not ${currentCountry}`;
                                    resultMessage.className = 'incorrect';

                                    // Highlight the correct country
                                    if (countryLayers[currentCountry]) {
                                        countryLayers[currentCountry].setStyle({
                                            fillColor: 'blue',
                                            fillOpacity: 0.5
                                        });
                                    }
                                }

                                // Show the next button
                                document.getElementById('next-flag').style.display = 'block';
                            });
                        }
                    }
                }).addTo(map);

                // Shuffle the countries to ensure random selection
                availableCountries = shuffleArray(availableCountries);

                // Start the game once the map is loaded
                selectNextCountry();
            })
            .catch(error => {
                console.error('Error loading GeoJSON data:', error);
                document.getElementById('map').innerHTML = '<p>Error loading map data. Please try again later.</p>';
            });
    </script>
</body>

</html>